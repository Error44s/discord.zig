name: CodeQL
on:
  push: { branches: [main] }
  pull_request: { branches: [main] }
  schedule: [{ cron: "0 2 * * 1" }]

permissions:
  contents: read
  security-events: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Detect languages
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          langs=""

          has_files() { test -n "$(git ls-files "$@" || true)"; }

          if has_files '*.c' '*.cc' '*.cpp' '*.h' '*.hpp'; then langs="${langs}cpp,"; fi
          if has_files '*.js' '*.jsx' '*.ts' '*.tsx'; then   langs="${langs}javascript,"; fi
          if has_files '*.py'; then                           langs="${langs}python,"; fi
          if has_files '*.go'; then                           langs="${langs}go,"; fi
          if has_files '*.java'; then                         langs="${langs}java,"; fi
          if has_files '*.rb'; then                           langs="${langs}ruby,"; fi
          if has_files '*.cs'; then                           langs="${langs}csharp,"; fi
          if has_files '*.kt' '*.kts'; then                   langs="${langs}kotlin,"; fi
          if has_files '*.swift'; then                        langs="${langs}swift,"; fi

          langs="${langs%,}"   # trim trailing comma
          echo "LANGS=$langs" >> "$GITHUB_ENV"
          echo "Detected languages: ${langs:-<none>}"
          if [ -n "$langs" ]; then
            echo "detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "detected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Init CodeQL
        if: env.LANGS != ''
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ env.LANGS }}
          queries: +security-extended

      - name: Autobuild (compiled languages)
        if: env.LANGS != '' && (contains(env.LANGS, 'cpp') || contains(env.LANGS, 'go'))
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        if: env.LANGS != ''
        uses: github/codeql-action/analyze@v3

      - name: Skip (no supported languages present)
        if: env.LANGS == ''
        run: echo "Skipping CodeQL â€” no supported languages in repo yet."
